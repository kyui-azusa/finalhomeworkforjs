项目结构

```text
my-notes-app/
├── package.json
├── index.js             # 入口文件
├── routes/              # 路由定义
│   └── notes.js
├── views/               # EJS 模板存放
│   └── index.ejs
├── public/              # 静态资源（CSS、JS）
├── data/                # 存放 markdown 或 note 元数据（可选）
├── db/                  # 数据库操作逻辑（如用 sqlite）
│   └── index.js
├── utils/               # 工具函数（如文件读取）
└── README.md            # 项目说明
```

## 环境

### 环境依赖

1. node>=18

### 开发依赖

1. nodemon
2. less

### 生产依赖

1. express
2. ejs
3. marked
4. gray-matter
5. sqlite3
6. echarts

### 快速开始

1. 安装依赖

   ```bash
   npm i
   ```

2. 启动服务

   开发环境

   ```bash
   npm run dev
   ```

   生产环境

   ```bash
   node index.js
   ```

## 项目介绍

### 项目亮点

**开发结构**

1. 组件式开发, 复用性强, 采用单一职责原则, 代码耦合低.
2. 使用 `less` 解决组件间可能产生的冲突.
3. 引入 `git` 进行版本管理, 降低了合作的成本, 提升了协作的效率.

**前端**

1. 侧边栏动效操作敏感, 会**根据鼠标移入方向**进行**不同的动效**以及展现**不同的信息**.
2. 收藏页面

   **未登录状态**有**轮播图**展示, 处理了首尾衔接问题, 封装函数 `layout` 统一处理图片行为

   **登录状态**会有**无缝文字滚动**展示用户收藏的笔记, 可链接到对应笔记, 还会展示**收藏笔记类型占比**, 未来添加笔记分类后可链接到对应的分类.
3. 登录页面中, 输入框的类"placeholder"元素在输入框聚焦时会悬浮至输入框上方, 提升用户的交互体验.

**后端**

1. 根据SRP, 使用 `express.router` 聚合拆分的路由, 结构清晰.
2. 代码耦合低, 将通用函数抽象聚合至 `utils/` 包括数据库处理以及笔记读取. 数据库处理中抽象出 `withDB` 函数, 优化开发体验, 使得可在 `js` 中获得类似 `python` 中使用 `with` 的开发体验, 不用担心忘记关闭数据库, 只用在回调函数中进行数据库的操作.
3. 边界完备, 考虑到用户异常行为以及可能出现的异常, 有兜底路由及重定向的功能, 若用户访问了空路由, 则会提示并在5秒后跳转至项目首页.
4. 鉴权逻辑完备, 用户登录后前端登录的跳转按钮变为用户的账号, 鼠标悬停效果变为 `Logout`. 后端同样做了校验, 若用户在登录后手动访问登录注册页面则会重定向至项目首页.
5. 数据安全性, 暂未设置管理员用户, 尚且不足, 但做了简单防护, 测试接口均只接收 `POST`  请求, 若收到 `GET` 请求仅返回 `ok` 用以迷惑无实质操作&信息.

### 结构

本项目主体结构由六个页面, 七个组件, 两种页面状态以及五个路由聚合器及其下若干路由组成.

1. 六个页面

   分别为首页, 收藏, 作者信息, 登录注册, 详情页以及异常路由处理页. 

   - 首页动态展示所有笔记信息
   - 收藏页有在登录与未登录时**分别有不同的处理方式** (详见 `两个状态`)
   - 作者信息的页面有作者信息及展示作者喜爱角色的3D卡片.
   - 登录注册在同一个页面自由切换, 且登录后会自动重定向至首页.
   - 详情页使用笔记展示区域 `less` 处理样式, 规避了和外部的样式冲突或样式过于单一的问题, 降低了处理问题的处理复杂度, `less` 作为开发依赖处理不会影响到生产环境.

2. 七个组件

   分别为 统一资源引入, 导航栏, 侧边栏和展示笔记简介的四个**通用组件**和作者信息页展示周梓煜同学喜爱的角色的3D卡片, 未登录时收藏页的轮播图以及详情页显示文章内容的三个解耦导向组件.

   **通用组件**

   - `head`: 控制标签页标题, 留出变量可自由设置标题, 统一样式引入, 动态处理根据是否为详情页添加对应样式, 优化了性能, 因为详情页对应样式体积略大.
   - `header`: 标题及导航栏, 根据传参动态设置导航栏样式以适配样式引导.
   - `sidebar`: 共用边栏, 有头像和预留分类功能. **头像会根据鼠标移入方向做出不同方向的翻转动画以及展示不同详情信息**.
   - `postInfo`: 笔记简介

   **解耦组件**

   -    `postContent`: 笔记详情页的主体, 负责承载样式.
   - `carousel`: 收藏页面未登录时的轮播图, 处理了首尾图片的衔接问题.
   - `3dcard`: 3D效果卡片, 展示角色.

3. 两种状态

   登录与未登录

   - 导航栏

     未登录时有 `Login` 板块, 登录后变为用户账号显示, 鼠标悬停时变为 `Logout` 的文字引导. 

   - 笔记详情页

     未登录时点击收藏会提示未登录并跳转至登录页, 登录后会显示已经收藏.

   - 收藏

     未登录时有轮播图显示, 首尾跳转连贯. 登录后滚动文字展示收藏的条目并以饼图展示笔记收藏类别占比.

   - 路由

     登录后访问登录页会重定向至项目落地页.

4. 五个聚合器

   分别聚合导航栏对应四个项目主逻辑和测试用的 `test` 后门路由, 后门路由均只接受 `POST` 请求.

### 功能

本项目是一个轻量级笔记网站, 具备以下核心功能

1. 首页展示

    - 展示所有笔记的标题、时间和简介

2. 笔记详情页

    - 路由格式：`/note/:slug`
    - 使用 `marked` 渲染 Markdown 内容为 HTML
    - 支持代码高亮、标题导航等

3. 账号系统

    - 当前项目未内置登录注册功能，默认所有功能对所有用户开放。
    - 若未来需要多用户支持，可扩展用户表（如 `users`）并引入会话管理中间件（如 `express-session` 或 JWT）。
    - 收藏夹等功能已为账号系统预留结构支持。

4. 收藏夹功能

    - 可将任意笔记加入收藏夹，点击收藏按钮即可触发写入操作。
    - 收藏信息存入 SQLite 数据库中的 `favorites` 表，字段包括 `id`、`slug`、`title`
    - 收藏记录可通过 `/favorites` 页面统一查看，展示已收藏笔记的标题及时间。
    - 未来可支持收藏取消、去重、分页等功能。

5. 404 页面

    - 对非法或不存在的路径进行统一拦截处理。
    - 使用独立的 `404.ejs` 模板进行渲染。
    - 页面将展示错误提示，并在 5 秒后自动跳转回首页（含倒计时提示）。

6. 样式与响应式布局

    - 使用 LESS 作为样式预处理器，结构清晰、模块划分合理。
    - 所有样式在开发时编写于 `style/` 目录，自动编译至 `public/style/*.css`。
    - 页面整体使用 Flex 布局，适配桌面浏览器。
    - 结构已预留移动端适配支持，便于后续拓展为响应式布局。

7. 数据源说明

    - 所有笔记数据来源于本地 Markdown 文件，路径位于 `source/_post/*.md`。
    - 每篇笔记包含标准的 YAML FrontMatter 格式，用于描述标题、时间、标签等元数据。
    - 使用 `gray-matter` 解析元数据，配合 `marked` 将 Markdown 内容转为 HTML。
    - 文件 slug（文件名去扩展名）作为笔记访问路由的唯一标识。

### 问题解决

1. 头像翻转

   滚动后就会无法正确识别鼠标移入的方向: 因为采用了前置 `const` 定义头像的位置, 改为在每次鼠标移入的事件内动态获取即可.

2. 样式冲突

   不同区域对相同标签有不同样式有全局定义而不依赖类样式, 添加类样式也并不方便: 采用 `less` 的嵌套写法, 即可让每个区域仅有各区域级的类样式的前提下完成样式的分割, 细化了颗粒度.

3. 数据查看

   使用 `sqlite3` 不方便查看数据库: 一是邪魔外道使用 `vscode` 扩展直接查看, 二是添加了接口方便查看, 且使用 `post` 请求进行初步防护, 防止用户在浏览器内可以直接访问到.

4. 语法缺失

   `express` 与 `ES6` 有所"冲突", 没有类和装饰器, 在处理一些普遍逻辑比如登录校验时遇到困难: 并非是我解决的, 而是发现 `express` 的设计真的天才, 堪称 `ES5` 下的 `ES6`, 以工厂函数实现了类似类的效果, 以 `express.use` 实现了类似装饰器的功能, 以精妙的设计补足了语言的不足, 令人赞叹.
   
4. 高亮报错

   vscode 对 `ejs` 的支持并不尽如人意, 比如代码块内快捷这输出使用的是 `xml` 的注释. 虽然也能起到效果, **猜测**是模板渲染时会进行忽略, 但**验证**后发现会出现在生产环境中, 是兼容早期 `Netscape` 时代的产物所以浏览器能识别.
   
   具体问题是书写如下代码时, lint 报错:
   
   ```ejs
   <script>
   	const tagData = <%- JSON.stringify(tagData) %>; // 报错: Expression expected.
   </script>
   ```
   
   尝试使用类似 Python 的 `# NOQA` 忽略该行 lint 检查:
   
   ```ejs
   <script>
   	const tagData = <%- JSON.stringify(tagData) %>; // eslint-disable-line no-unused-vars
   </script>
   ```
   
   报错依然存在, 可见并非是由 eslint 提示的错误 (报错中也确实没有标注来源为 eslint), 所以确实就是 vscode 的问题
   
   研究后将 `ejs` 表达式解析延后至运行时以解决:
   
   ```ejs
   <script>
   	const tagData = JSON.parse('<%- JSON.stringify(tagData) %>');
   </script>
   ```
   
   报错消失并且运行顺利.
   
   